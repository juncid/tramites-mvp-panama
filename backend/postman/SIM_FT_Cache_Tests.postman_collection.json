{
  "info": {
    "_postman_id": "sim-ft-cache-tests-2025",
    "name": "SIM_FT - Redis Cache Tests",
    "description": "Colecci√≥n de pruebas para validar el funcionamiento del Redis Cache en endpoints SIM_FT.\n\n**üéØ Objetivo:**\nVerificar que el caching funciona correctamente:\n- Cache Hit/Miss\n- Tiempo de respuesta (Cache vs DB)\n- Invalidaci√≥n autom√°tica en POST/PUT\n- TTL de 5 minutos\n\n**üìã Tests Incluidos:**\n1. Cache Miss - Primera consulta (DB query)\n2. Cache Hit - Segunda consulta (Redis)\n3. Cache Invalidation - POST\n4. Cache Rebuild - GET despu√©s de POST\n5. Cache Invalidation - PUT\n6. Individual Cache - GET by ID\n\n**üîß Configuraci√≥n:**\n- Ejecutar en orden secuencial\n- Verificar Redis est√° activo\n- Monitorear logs del backend\n\n**üìä M√©tricas:**\n- Cache Miss: ~100-500ms (query DB)\n- Cache Hit: ~5-50ms (Redis)\n- Mejora esperada: 10x-20x m√°s r√°pido\n\n**Autor:** Sistema de Tr√°mites MVP Panam√°\n**Fecha:** 2025-10-24\n**Versi√≥n:** 1.0.0",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8000",
      "type": "string"
    },
    {
      "key": "api_prefix",
      "value": "/api/v1/sim-ft",
      "type": "string"
    },
    {
      "key": "num_annio",
      "value": "2025",
      "type": "string"
    },
    {
      "key": "num_tramite",
      "value": "",
      "type": "string"
    },
    {
      "key": "num_registro",
      "value": "",
      "type": "string"
    },
    {
      "key": "cod_tramite",
      "value": "",
      "type": "string"
    },
    {
      "key": "response_time_first",
      "value": "",
      "type": "string"
    },
    {
      "key": "response_time_second",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "0. Setup - Obtener Tipo de Tr√°mite",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Setup successful\", function () {",
              "    pm.response.to.have.status(200);",
              "    var tipos = pm.response.json();",
              "    pm.expect(tipos.length).to.be.above(0);",
              "    pm.collectionVariables.set(\"cod_tramite\", tipos[0].cod_tramite);",
              "    console.log(\"‚úÖ Setup: cod_tramite = \" + tipos[0].cod_tramite);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}{{api_prefix}}/tramites-tipos",
          "host": ["{{base_url}}{{api_prefix}}"],
          "path": ["tramites-tipos"]
        },
        "description": "Obtiene un tipo de tr√°mite v√°lido para usar en las pruebas"
      }
    },
    {
      "name": "1. Cache MISS - Primera Consulta (DB Query)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response is array\", function () {",
              "    pm.expect(pm.response.json()).to.be.an('array');",
              "});",
              "",
              "var responseTime = pm.response.responseTime;",
              "pm.collectionVariables.set(\"response_time_first\", responseTime);",
              "",
              "console.log(\"‚è±Ô∏è Primera consulta (Cache MISS): \" + responseTime + \"ms\");",
              "console.log(\"üíæ Datos cargados desde SQL Server\");",
              "console.log(\"‚úÖ Datos almacenados en Redis con TTL 300s\");",
              "",
              "if (pm.response.json().length > 0) {",
              "    var tramite = pm.response.json()[0];",
              "    pm.collectionVariables.set(\"num_tramite\", tramite.NUM_TRAMITE);",
              "    pm.collectionVariables.set(\"num_registro\", tramite.NUM_REGISTRO);",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}{{api_prefix}}/tramites?num_annio={{num_annio}}&skip=0&limit=10",
          "host": ["{{base_url}}{{api_prefix}}"],
          "path": ["tramites"],
          "query": [
            {
              "key": "num_annio",
              "value": "{{num_annio}}"
            },
            {
              "key": "skip",
              "value": "0"
            },
            {
              "key": "limit",
              "value": "10"
            }
          ]
        },
        "description": "**Test 1: Cache MISS**\n\nPrimera consulta debe ir a la base de datos.\n\n**Esperado:**\n- Response time: ~100-500ms\n- Datos desde SQL Server\n- Cache creado en Redis\n\n**Cache Key:**\n`sim_ft:tramites:2025:None:None:None:0:10:None:None`"
      }
    },
    {
      "name": "2. Cache HIT - Segunda Consulta (Redis)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "var responseTime = pm.response.responseTime;",
              "pm.collectionVariables.set(\"response_time_second\", responseTime);",
              "",
              "var firstTime = parseInt(pm.collectionVariables.get(\"response_time_first\"));",
              "var improvement = ((firstTime - responseTime) / firstTime * 100).toFixed(1);",
              "",
              "pm.test(\"Cache is faster than DB\", function () {",
              "    pm.expect(responseTime).to.be.below(firstTime);",
              "});",
              "",
              "console.log(\"\\nüìä RESULTADOS COMPARATIVOS:\");",
              "console.log(\"‚è±Ô∏è Primera consulta (DB):    \" + firstTime + \"ms\");",
              "console.log(\"‚ö° Segunda consulta (Cache): \" + responseTime + \"ms\");",
              "console.log(\"üöÄ Mejora:                   \" + improvement + \"%\");",
              "console.log(\"‚úÖ Datos servidos desde Redis (Cache HIT)\");",
              "",
              "pm.test(\"Response time with cache < 100ms\", function () {",
              "    pm.expect(responseTime).to.be.below(100);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}{{api_prefix}}/tramites?num_annio={{num_annio}}&skip=0&limit=10",
          "host": ["{{base_url}}{{api_prefix}}"],
          "path": ["tramites"],
          "query": [
            {
              "key": "num_annio",
              "value": "{{num_annio}}"
            },
            {
              "key": "skip",
              "value": "0"
            },
            {
              "key": "limit",
              "value": "10"
            }
          ]
        },
        "description": "**Test 2: Cache HIT**\n\nMisma consulta debe venir del cache.\n\n**Esperado:**\n- Response time: ~5-50ms (10x-100x m√°s r√°pido)\n- Datos desde Redis\n- No query a SQL Server\n\n**Validaci√≥n:**\n- Comparar tiempos de respuesta\n- Verificar mejora de performance"
      }
    },
    {
      "name": "3. Cache INVALIDATION - POST Nuevo Tr√°mite",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Tr√°mite creado\", function () {",
              "    pm.response.to.have.status(201);",
              "});",
              "",
              "if (pm.response.code === 201) {",
              "    var tramite = pm.response.json();",
              "    pm.collectionVariables.set(\"num_tramite\", tramite.NUM_TRAMITE);",
              "    pm.collectionVariables.set(\"num_registro\", tramite.NUM_REGISTRO);",
              "    ",
              "    console.log(\"‚úÖ Tr√°mite creado: \" + tramite.NUM_ANNIO + \"-\" + tramite.NUM_TRAMITE + \"-\" + tramite.NUM_REGISTRO);",
              "    console.log(\"üóëÔ∏è CACHE INVALIDADO\");",
              "    console.log(\"   - redis.keys('sim_ft:tramites:*')\");",
              "    console.log(\"   - redis.delete(*keys)\");",
              "    console.log(\"‚è≠Ô∏è Pr√≥xima consulta GET reconstruir√° cache\");",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"NUM_ANNIO\": 2025,\n  \"NUM_TRAMITE\": 999,\n  \"NUM_REGISTRO\": 999,\n  \"COD_TRAMITE\": \"{{cod_tramite}}\",\n  \"IND_ESTATUS\": \"01\",\n  \"IND_PRIORIDAD\": \"1\",\n  \"OBS_OBSERVA\": \"Test Cache Invalidation - Created at \" + new Date().toISOString()\n}"
        },
        "url": {
          "raw": "{{base_url}}{{api_prefix}}/tramites",
          "host": ["{{base_url}}{{api_prefix}}"],
          "path": ["tramites"]
        },
        "description": "**Test 3: Cache Invalidation (POST)**\n\nCrear un tr√°mite debe invalidar todo el cache.\n\n**Esperado:**\n- Status 201 Created\n- Redis: DELETE sim_ft:tramites:*\n- Cache vac√≠o despu√©s del POST\n\n**Verificar en terminal:**\n```bash\ndocker exec tramites-redis redis-cli KEYS \"sim_ft:tramites:*\"\n# Debe retornar: (empty array)\n```"
      }
    },
    {
      "name": "4. Cache REBUILD - GET Despu√©s de POST",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "var responseTime = pm.response.responseTime;",
              "",
              "pm.test(\"Cache rebuilt (slower than cached query)\", function () {",
              "    var cachedTime = parseInt(pm.collectionVariables.get(\"response_time_second\"));",
              "    pm.expect(responseTime).to.be.above(cachedTime);",
              "});",
              "",
              "console.log(\"\\nüîÑ CACHE REBUILD:\");",
              "console.log(\"‚è±Ô∏è Response time: \" + responseTime + \"ms\");",
              "console.log(\"üíæ Datos cargados desde SQL Server (cache vac√≠o)\");",
              "console.log(\"‚úÖ Nuevo cache creado en Redis\");",
              "console.log(\"üîë Cache incluye tr√°mite reci√©n creado\");"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}{{api_prefix}}/tramites?num_annio={{num_annio}}&skip=0&limit=10",
          "host": ["{{base_url}}{{api_prefix}}"],
          "path": ["tramites"],
          "query": [
            {
              "key": "num_annio",
              "value": "{{num_annio}}"
            },
            {
              "key": "skip",
              "value": "0"
            },
            {
              "key": "limit",
              "value": "10"
            }
          ]
        },
        "description": "**Test 4: Cache Rebuild**\n\nDespu√©s de invalidaci√≥n, primera consulta reconstruye cache.\n\n**Esperado:**\n- Response time similar a Test 1 (DB query)\n- Incluye el tr√°mite reci√©n creado\n- Nuevo cache en Redis\n\n**Validaci√≥n:**\n- Tiempo m√°s lento que cache hit\n- Datos frescos desde DB"
      }
    },
    {
      "name": "5. Cache INVALIDATION - PUT Update",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Tr√°mite actualizado\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"FEC_ACTUALIZA updated\", function () {",
              "    var tramite = pm.response.json();",
              "    pm.expect(tramite).to.have.property('FEC_ACTUALIZA');",
              "});",
              "",
              "console.log(\"‚úÖ Tr√°mite actualizado\");",
              "console.log(\"üóëÔ∏è CACHE INVALIDADO (PUT)\");",
              "console.log(\"   - Todas las claves sim_ft:tramites:* eliminadas\");",
              "console.log(\"   - Todas las claves sim_ft:tramite:* eliminadas\");"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"IND_ESTATUS\": \"02\",\n  \"OBS_OBSERVA\": \"Test Cache Invalidation PUT - Updated at \" + new Date().toISOString()\n}"
        },
        "url": {
          "raw": "{{base_url}}{{api_prefix}}/tramites/2025/999/999",
          "host": ["{{base_url}}{{api_prefix}}"],
          "path": ["tramites", "2025", "999", "999"]
        },
        "description": "**Test 5: Cache Invalidation (PUT)**\n\nActualizar un tr√°mite debe invalidar el cache.\n\n**Esperado:**\n- Status 200 OK\n- Redis: DELETE sim_ft:tramites:*\n- Cache vac√≠o despu√©s del PUT"
      }
    },
    {
      "name": "6. Individual Cache - GET by ID",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Has tramite data\", function () {",
              "    var tramite = pm.response.json();",
              "    pm.expect(tramite).to.have.property('NUM_ANNIO');",
              "    pm.expect(tramite).to.have.property('NUM_TRAMITE');",
              "    pm.expect(tramite).to.have.property('NUM_REGISTRO');",
              "});",
              "",
              "var responseTime = pm.response.responseTime;",
              "console.log(\"\\nüéØ INDIVIDUAL CACHE:\");",
              "console.log(\"‚è±Ô∏è Response time: \" + responseTime + \"ms\");",
              "console.log(\"üîë Cache Key: sim_ft:tramite:2025:999:999\");",
              "console.log(\"‚úÖ Tr√°mite individual cacheado\");",
              "",
              "pm.test(\"Response time acceptable\", function () {",
              "    pm.expect(responseTime).to.be.below(500);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}{{api_prefix}}/tramites/2025/999/999",
          "host": ["{{base_url}}{{api_prefix}}"],
          "path": ["tramites", "2025", "999", "999"]
        },
        "description": "**Test 6: Individual Cache**\n\nGET by ID tiene cache separado del listado.\n\n**Cache Key:**\n`sim_ft:tramite:2025:999:999`\n\n**Diferencia con lista:**\n- Cache individual por tr√°mite\n- No afectado por filtros\n- Invalidado en POST/PUT global"
      }
    },
    {
      "name": "7. Verificar Cache Hit Individual",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "var responseTime = pm.response.responseTime;",
              "",
              "pm.test(\"Cache hit is faster\", function () {",
              "    pm.expect(responseTime).to.be.below(100);",
              "});",
              "",
              "console.log(\"\\n‚ö° CACHE HIT INDIVIDUAL:\");",
              "console.log(\"‚è±Ô∏è Response time: \" + responseTime + \"ms\");",
              "console.log(\"‚úÖ Datos desde Redis (Cache HIT)\");",
              "console.log(\"üöÄ Muy r√°pido - sin query a DB\");"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}{{api_prefix}}/tramites/2025/999/999",
          "host": ["{{base_url}}{{api_prefix}}"],
          "path": ["tramites", "2025", "999", "999"]
        },
        "description": "**Test 7: Individual Cache Hit**\n\nSegunda consulta del mismo tr√°mite debe ser muy r√°pida.\n\n**Esperado:**\n- Response time < 50ms\n- Datos desde Redis\n- Mucho m√°s r√°pido que primera consulta"
      }
    }
  ]
}
