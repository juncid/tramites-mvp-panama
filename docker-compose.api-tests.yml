version: '3.8'

# ===========================================================================
# Docker Compose para Testing Automatizado de API
# Sistema de TrÃ¡mites Migratorios de PanamÃ¡
#
# Este compose levanta el ambiente completo (backend + BD + Redis) y ejecuta
# las colecciones de Postman usando Newman para validar todos los endpoints.
#
# Uso:
#   docker-compose -f docker-compose.api-tests.yml up --abort-on-container-exit
#   docker-compose -f docker-compose.api-tests.yml down
#
# CaracterÃ­sticas:
#   - Levanta backend, base de datos y Redis
#   - Espera a que los servicios estÃ©n listos
#   - Ejecuta todas las colecciones de Postman
#   - Genera reportes HTML detallados
#   - Se detiene automÃ¡ticamente al finalizar
# ===========================================================================

services:
  # ===========================================================================
  # BASE DE DATOS - SQL Server para Testing
  # ===========================================================================
  db-test:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: tramites-db-test
    hostname: db-test
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=TestP@ssw0rd2025!
      - MSSQL_PID=Developer
    ports:
      - "1434:1433"
    volumes:
      - test_db_data:/var/opt/mssql
    networks:
      - test-network
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "TestP@ssw0rd2025!" -Q "SELECT 1" -C || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ===========================================================================
  # REDIS - Cache y Sesiones para Testing
  # ===========================================================================
  redis-test:
    image: redis:7-alpine
    container_name: tramites-redis-test
    hostname: redis-test
    ports:
      - "6380:6379"
    volumes:
      - test_redis_data:/data
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ===========================================================================
  # BACKEND API - FastAPI Application para Testing
  # ===========================================================================
  backend-test:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: tramites-backend-test
    hostname: backend-test
    environment:
      # Database
      - DATABASE_HOST=db-test
      - DATABASE_PORT=1433
      - DATABASE_NAME=SIM_PANAMA
      - DATABASE_USER=sa
      - DATABASE_PASSWORD=TestP@ssw0rd2025!
      - DATABASE_DRIVER=ODBC Driver 18 for SQL Server
      
      # Redis
      - REDIS_HOST=redis-test
      - REDIS_PORT=6379
      - REDIS_DB=0
      
      # Application
      - ENVIRONMENT=testing
      - LOG_LEVEL=INFO
      - FRONTEND_URL=http://localhost:3000
      
      # Testing specific
      - TESTING_MODE=true
      - CREATE_TEST_DATA=true
    ports:
      - "8001:8000"
    depends_on:
      db-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - test-network
    volumes:
      - ./backend:/app
      - test_uploads:/app/uploads
    command: >
      sh -c "
        echo 'â³ Esperando a que la base de datos estÃ© lista...' &&
        sleep 10 &&
        echo 'ğŸ“Š Inicializando base de datos de testing...' &&
        python init_database.py &&
        echo 'ğŸ“ Cargando datos iniciales bÃ¡sicos...' &&
        python load_initial_data.py &&
        echo 'ğŸ² Cargando datos de prueba completos (catÃ¡logos PPSH, workflows, etc.)...' &&
        python load_test_data.py &&
        echo 'âœ… Base de datos lista con datos de prueba' &&
        echo 'ğŸš€ Iniciando servidor FastAPI...' &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 45s

  # ===========================================================================
  # NEWMAN API TESTER - Ejecutor de Colecciones Postman
  # ===========================================================================
  newman-api-tests:
    image: postman/newman:6-alpine
    container_name: tramites-newman-tests
    hostname: newman-tests
    depends_on:
      backend-test:
        condition: service_healthy
    networks:
      - test-network
    volumes:
      - ./backend:/etc/newman
      - ./test-reports:/etc/newman/reports
    environment:
      - BASE_URL=http://backend-test:8000
    entrypoint: >
      sh -c "
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
        echo 'ğŸ§ª INICIANDO SUITE DE TESTS DE API' &&
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
        echo '' &&
        
        echo 'â³ Esperando 5 segundos adicionales para estabilidad...' &&
        sleep 5 &&
        echo '' &&
        
        echo 'ğŸ“‹ Instalando reporter HTML extra...' &&
        npm install -g newman-reporter-htmlextra &&
        echo '' &&
        
        echo 'ğŸ¥ Verificando health del backend...' &&
        wget -q --spider http://backend-test:8000/health || (echo 'âŒ Backend no estÃ¡ disponible' && exit 1) &&
        echo 'âœ… Backend estÃ¡ disponible' &&
        echo '' &&
        
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
        echo 'ğŸ“Š TEST 1/3: PPSH Complete API' &&
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
        newman run /etc/newman/PPSH_Complete_API.postman_collection.json --env-var base_url=http://backend-test:8000 --env-var api_prefix=/api/v1/ppsh --delay-request 200 --timeout-request 30000 --reporters cli,htmlextra,json --reporter-htmlextra-export /etc/newman/reports/ppsh-report.html --reporter-htmlextra-title 'PPSH API Test Report' --reporter-htmlextra-darkTheme --reporter-json-export /etc/newman/reports/ppsh-results.json || echo 'âš ï¸  PPSH tests had failures' &&
        
        echo '' &&
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
        echo 'ğŸ“Š TEST 2/3: Workflow API' &&
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
        newman run /etc/newman/Workflow_API_Tests.postman_collection.json --env-var base_url=http://backend-test:8000 --env-var api_prefix=/api/v1/workflow --delay-request 200 --timeout-request 30000 --reporters cli,htmlextra,json --reporter-htmlextra-export /etc/newman/reports/workflow-report.html --reporter-htmlextra-title 'Workflow API Test Report' --reporter-htmlextra-darkTheme --reporter-json-export /etc/newman/reports/workflow-results.json || echo 'âš ï¸  Workflow tests had failures' &&
        
        echo '' &&
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
        echo 'ğŸ“Š TEST 3/3: TrÃ¡mites Base API' &&
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
        newman run /etc/newman/Tramites_Base_API.postman_collection.json --env-var base_url=http://backend-test:8000 --env-var api_prefix=/api/v1 --delay-request 200 --timeout-request 30000 --reporters cli,htmlextra,json --reporter-htmlextra-export /etc/newman/reports/tramites-report.html --reporter-htmlextra-title 'TrÃ¡mites Base API Test Report' --reporter-htmlextra-darkTheme --reporter-json-export /etc/newman/reports/tramites-results.json || echo 'âš ï¸  Tramites tests had failures' &&
          --timeout-request 30000 \
          --reporters cli,htmlextra,json \
          --reporter-htmlextra-export /etc/newman/reports/tramites-report.html \
          --reporter-htmlextra-title 'TrÃ¡mites Base API Test Report' \
          --reporter-htmlextra-darkTheme \
          --reporter-json-export /etc/newman/reports/tramites-results.json || echo 'âš ï¸  Tramites tests had failures' &&
        
        echo '' &&
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
        echo 'âœ… TODOS LOS TESTS COMPLETADOS EXITOSAMENTE' &&
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
        echo '' &&
        echo 'ğŸ“Š Reportes generados en: ./test-reports/' &&
        echo '   - ppsh-report.html' &&
        echo '   - workflow-report.html' &&
        echo '   - tramites-report.html' &&
        echo '' &&
        echo 'ğŸ“ˆ Resultados JSON en: ./test-reports/' &&
        echo '   - ppsh-results.json' &&
        echo '   - workflow-results.json' &&
        echo '   - tramites-results.json' &&
        echo '' &&
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' ||
        (
          echo '' &&
          echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
          echo 'âŒ TESTS FALLARON - Revisar logs arriba' &&
          echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' &&
          exit 1
        )
      "

  # ===========================================================================
  # REPORT VIEWER - Servidor HTTP Simple para ver reportes
  # ===========================================================================
  report-viewer:
    image: nginx:alpine
    container_name: tramites-report-viewer
    hostname: report-viewer
    ports:
      - "8080:80"
    volumes:
      - ./test-reports:/usr/share/nginx/html:ro
    networks:
      - test-network
    depends_on:
      - newman-api-tests
    labels:
      - "traefik.enable=false"

# ===========================================================================
# NETWORKS
# ===========================================================================
networks:
  test-network:
    driver: bridge
    name: tramites-test-network

# ===========================================================================
# VOLUMES
# ===========================================================================
volumes:
  test_db_data:
    name: tramites-test-db-data
  test_redis_data:
    name: tramites-test-redis-data
  test_uploads:
    name: tramites-test-uploads
